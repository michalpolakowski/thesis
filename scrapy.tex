\chapter {Scraper} 
W niniejszym rozdziale zajmę się omówieniem użytych w projekcie zagadnień dotyczących webscrapingu.
Scrapy jest jedną z najpopularniejszych bibliotek pythonowych, które mają za zadanie zbierać informacje ze stron internetowych.
Webscraping oparty jest na pyhtonowym frameworku \emph{Scrapy}, wspieranym przez biblioteki \emph{Splash} oraz \emph{XPath}.
Uzyskiwałem wiedzę posługując się dokumentacjami bibliotek \emph{Scrapy}\footnote{https://doc.scrapy.org}, \emph{Splash}\footnote{https://splash.readthedocs.io/en/stable/api.html} oraz \emph{XPath}\footnote{https://doc.scrapy.org/en/xpath-tutorial/topics/xpath-tutorial.html}.
Skrypt uruchamiany jest na trzech stronach sklepów internetowych: \emph{https://reserved.com, https://zalando.pl, https://domodi.pl}. 
Wykonywanie programu jest podzielone na trzy etapy:
\begin{enumerate}
	\item Po uzyskaniu słów kluczowych program wprowadza w wyszukiwarce strony daną frazę wpisaną przez użytkownika.
	\item Przekierowuje do wszystkich wyników wyszukiwania.
	\item Zbiera oraz zwraca informację z rubryki wygenerowanej dynamicznie przez stronę, która 	ma na celu poinformowanie kupującego o rzeczach zakupionych przez innych 	użytkowników wraz z wyszukiwanym ubraniem.
\end{enumerate}
\section{Opis etapów}

\subsection{Etap 1}
	Aplikacja włącza program scrapingowy za pomocą następującej komendy: \emph{scrapy crawl clothing -a tag=”fraza” -o results.json}.
Oznacza to uruchomienie programu o nazwie \emph{clothing} z parametrem do wyszukania (tag), a rezultat będzie przechowywany do pliku \emph{results.json}.
Po uruchomieniu do każdej strony internetowej inicjowana jest metoda \emph{search}, która za pomocą \emph{XPath} odszukuje formularz na stronie głównej sklepu, wpisuje nazwę ubrania, którą chce użytkownik i wysyła request z żądaniem wyszukania.

\subsection{Etap 2}
	Strona sklepu internetowego zwraca wyniki wyszukiwania. Program zbiera wszystkie linki do wyszukanych ubrań za pomocą \emph{XPath}, który przeszukuje w kodzie HTML odnośniki mające w adresie przekierowującym rodzaj ubrania. Następnie przechodzi do tych stron odpalając kolejną metodę, która zależnie od sklepu szuka w kodzie HTML strony innych struktur.

\subsection{Etap 3}
	Będąc na tym etapie program jest już w dokładnie jednej ofercie zakupu ubrania. Zależnie od strony, skrypt zachowuje się w inny sposób:
\begin{itemize}
	 \item dla stron \emph{reserved} oraz \emph{domodi} od razu następuje przeszukiwanie kodu HTML w celu znalezienia proponowanych rzeczy poprzez znalezienie odpowiedniej struktury
		\begin{itemize} 
			\item dla sklepu Reserved każda oferta przeszukiwania jest umieszczona w znaczniku \textless div\textgreater, a znacznik ten zaczyna się od klasy, która ma nazwę \emph{portrait}. Dla Domodi jest to każdy 	znacznik \textless li\textgreater.
		\end{itemize}
	\item dla sklepu Zalando wyszukiwany jest najpierw tekst \emph{zobacz więcej}, w który aplikacja przechodzi, żeby zobaczyć pełną listę proponowanych przez sklep ubrań.
\end{itemize}
Program pobiera następujące informacje z propozycji kupna:
\begin{itemize}
	\item adres URL
	\item zdjęcie ubrania
	\item cenę
	\item nazwę ubrania
\end{itemize}
Informacje zapisywane są tylko wtedy, jeśli jest ich cały komplet – powoduje to uniknięcie przedostawania się do wyników niepotrzebnych danych bądź innych przypadkowo pobranych rzeczy.
Zapisywanie odbywa się w formacie json o strukturze słownikowej:
\begin{itemize}
\item[] \emph{\{ClothesName: \{ "image": imageURL, "price": PRICE, "url": URL\}\}}
\item[] \emph{ClothesName} – przechowywany w formacie string, jako wartość zawiera słownik ze szczegółami
\item[] \emph{imageURL} – przechowywany w formacie string, zawiera adres do zdjęcia ubrania
\item[] \emph{PRICE} – przechowywany w formacie string, zależnie od strony może być z końcówką „zł” lub 	„PLN”
\item[] \emph{URL} – przechowywany w formacie string, zawiera adres do strony sklepu z daną rzeczą
\end{itemize}
Program na bieżąco przesyła taki słownik do pliku wynikowego, z którego dalsza część programu może na bieżąco czytać.


Program, żeby mógł działać na dynamicznych stronach używa biblioteki Splash.
Splash używa funkcji napisanej w języku Lua:
\begin{lstlisting}
function main(splash, args)
          assert(splash:go(args.url))
          assert(splash:wait(0.5))
          assert(splash:set_viewport_full())
          return {
            html = splash:html()}
            end
\end{lstlisting}
\begin{itemize}
\item[] Splash:go(args.url) przechodzi na stronę podaną w argumencie.
\item[] Splash:wait(0.5) – określa jak długo program czeka na załadowanie strony
\item[] Splash:set\_viewport\_full() sprawia, że wczytywana jest cała strona HTML


Wysyłanie requestów do stron również odbywa się za pomocą metody z biblioteki Splash - \emph{SplashRequest}, która jako argumenty przyjmuje adres strony, metodę do której ma przejść w następnym kroku oraz argumenty (przekazanie całej funkcji z języka Lua jako parametr).
\end{itemize}
\end{document}
